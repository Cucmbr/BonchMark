@page "/timetable"
@inject NavigationManager Navigation
@inject IJSRuntime JsRuntime

<body>
        <div class="timetable_tabbar">
            <div class="slider"></div>
		    <a class="tabbutton" href="timetable/#Monday"><h1 class="hh1">ПН</h1></a>
            <a class="tabbutton" href="timetable/#Tuesday"><h1 class="hh2">ВТ</h1></a>
            <a class="tabbutton" href="timetable/#Wednesday"><h1 class="hh3">СР</h1></a>
            <a class="tabbutton" href="timetable/#Thursday"><h1 class="hh4">ЧТ</h1></a>
            <a class="tabbutton" href="timetable/#Friday"><h1 class="hh5">ПТ</h1></a>
            <a class="tabbutton" href="timetable/#Saturday"><h1 class="hh6">СБ</h1></a>
        </div>
        <div class="main_container" style="@scrollLock" @ontouchend="ScrollCheck" @onmouseup="ScrollCheck">
        <div class="week_arrow arrow_left">
            @* Arrow *@<svg style="@arrowStyle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z" /></svg>
            @* Loading *@<svg style="@loadingStyle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M304 48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zm0 416a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM48 304a48 48 0 1 0 0-96 48 48 0 1 0 0 96zm464-48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM142.9 437A48 48 0 1 0 75 369.1 48 48 0 1 0 142.9 437zm0-294.2A48 48 0 1 0 75 75a48 48 0 1 0 67.9 67.9zM369.1 437A48 48 0 1 0 437 369.1 48 48 0 1 0 369.1 437z" /></svg>
        </div>
            <div class="timetable_container" style="@scrollLock">
            @foreach (var day in App.Week)
                {
                    <div class="timetable_day" id="@day.Date.DayOfWeek">
                        <h1 style="display: flex; align-items: center; gap: 1rem;">@day.Date.Date.ToString("d MMMM", System.Globalization.CultureInfo.GetCultureInfo("ru-RU")) <span style=@(weekDelta != 0 ? "background: var(--main-color); border-radius: 1rem; padding: 0.2rem 0.5rem; color: var(--main-bgcolor); font-size: 1.25rem;" : "display: none;")>@(weekDelta != 0 ? $"{(weekDelta > 0 ? "+" : "")}{weekDelta}" : "")</span></h1>
                        @if (day.Classes != null)
                        {
                            for (int i = 0; i < day.Classes.Count; i++)
                            {
                                ChangeColor(day.Classes[i]);
                                <div class="class_item">
                                    <div class="class_number" style="@color_style">@day.Classes[i].Time[0]</div>
                                    <div class="card_container">
                                        <div class="class_label" style="@color_style">@day.Classes[i].Type[0] | @day.Classes[i].Time[1]</div>
                                        <div class="class_card">
                                            <div class="class_name">@day.Classes[i].Name</div>
                                        <div class="class_teacher_place">
                                            @day.Classes[i].Teacher <b>@day.Classes[i].Place</b> @if (day.Classes[i].Type[1] != null)
                                            {
                                                <div class="marked"><svg xmlns="http://www.w3.org/2000/svg" height="1rem" fill="#282828" viewBox="0 0 448 512"><path d="M64 32C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64H64zM337 209L209 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L303 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z" /></svg> @day.Classes[i].Type[1].Substring(16)</div>
                                            }
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="status_message_dayoff">
                                <div class="status_message" style="display: block;">Пар сегодня нет 😎</div>
                            </div>
                        }
                    </div>
                }
            </div>
            <div class="week_arrow arrow_right">
                @* Arrow *@<svg style="@arrowStyle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M438.6 278.6c12.5-12.5 12.5-32.8 0-45.3l-160-160c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L338.8 224 32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l306.7 0L233.4 393.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l160-160z" /></svg>
                @* Loading *@<svg style="@loadingStyle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M304 48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zm0 416a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM48 304a48 48 0 1 0 0-96 48 48 0 1 0 0 96zm464-48a48 48 0 1 0 -96 0 48 48 0 1 0 96 0zM142.9 437A48 48 0 1 0 75 369.1 48 48 0 1 0 142.9 437zm0-294.2A48 48 0 1 0 75 75a48 48 0 1 0 67.9 67.9zM369.1 437A48 48 0 1 0 437 369.1 48 48 0 1 0 369.1 437z" /></svg>
            </div>
        </div>

    
</body>
<AnchorNavigation />
<script>
    document.querySelector('.timetable_container').addEventListener('scroll', () => {
        document.querySelector('.timetable_tabbar').style.setProperty('--scroll', (document.querySelector('.timetable_container').scrollLeft / (document.querySelector('.timetable_container').scrollWidth - window.innerWidth)));
	}, false);

    document.querySelector('.main_container').addEventListener('scroll', () => {
        document.querySelector('.main_container').style.setProperty('--main_scroll', (document.querySelector('.main_container').scrollLeft / (document.querySelector('.main_container').scrollWidth - window.innerWidth)));
    }, false);

    function GetScroll() {
        var scroll = document.querySelector('.main_container').getAttribute('style');
        return scroll;
    }
</script>

@code {
    private string color_style;
    private ElementReference mainContainer;
    private int weekDelta = 0;
    private string loadingStyle = "display: none;";
    private string arrowStyle = "display: block;";
    private string scrollLock = "overflow-x: scroll;";

    private async Task ScrollCheck()
    {

        string scrollValue = await JsRuntime.InvokeAsync<string>("GetScroll");
#if ANDROID
    float scroll = Convert.ToSingle(scrollValue.Substring(scrollValue.IndexOf("--main_scroll:") + 14, scrollValue.Length - scrollValue.IndexOf("--main_scroll:") - 15), new System.Globalization.CultureInfo("en-US"));
#else
        float scroll = Convert.ToSingle(scrollValue.Substring(scrollValue.IndexOf("--main_scroll: ") + 15, scrollValue.Length - scrollValue.IndexOf("--main_scroll: ") - 16), new System.Globalization.CultureInfo("en-US"));
#endif

        switch(scroll)
        {
            case 0f:
                scrollLock = "overflow-x: hidden;";
                arrowStyle = "display: none;";
                loadingStyle = "display: block;";
                StateHasChanged();
                weekDelta--;
                App.Week = await App.GenerateWeekAsync(App.Timetable.CurrentWeek + weekDelta);
                scrollLock = "overflow-x: scroll;";
                arrowStyle = "display: block;";
                loadingStyle = "display: none;";
                Navigation.NavigateTo("/timetable/#Monday");
                break;
            case 1f:
                scrollLock = "overflow-x: hidden;";
                arrowStyle = "display: none;";
                loadingStyle = "display: block;";
                StateHasChanged();
                weekDelta++;
                App.Week = await App.GenerateWeekAsync(App.Timetable.CurrentWeek + weekDelta);
                scrollLock = "overflow-x: scroll;";
                arrowStyle = "display: block;";
                loadingStyle = "display: none;";
                Navigation.NavigateTo("/timetable/#Monday");
                break;
        }
    }

    private void ChangeColor(ClassInfo classInfo)
    {
        switch (classInfo.Type[0])
        {
            case "Лекция":
                color_style = "background-color: #006cb7";
                break;
            case "Практические занятия":
                color_style = "background-color: #67bd45;";
                break;
            case "Лабораторная работа":
                color_style = "background-color: #ed1556";
                break;
            case "Зачет":
                color_style = "background-color: #492D15";
                break;
            case "Консультация":
                color_style = "background-color: #492D15";
                break;
            case "Экзамен":
                color_style = "background-color: #492D15";
                break;
        }
    }
}
